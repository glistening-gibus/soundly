'use strict';

var chai = require('chai');
var chaiAsPromised = require('chai-as-promised');
var assert = chai.assert;
chai.use(chaiAsPromised);
var should = chai.should();
var expect = chai.expect;
var queue = require('../server/routes/queue.js');
var User = require('../server/models/User.js');

var song0 = {
  id: '100',
  title: 'no sleep till brooklyn',
  duration: '50',
  stream_url: 'soundcloud/101',
  artwork_url: 'http://beastie.com'
};
var song1 = {
  id: '101',
  title: 'like a prayer',
  duration: '70',
  stream_url: 'soundcloud/102',
  artwork_url: 'madonna.com'
};
var song2 = {
  id: '102',
  title: 'hot in herre',
  duration: '30',
  stream_url: 'soundcloud/103',
  artwork_url: 'http://hotinherre.com'
};

describe('add and remove songs from the queue', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // Empty the queue
    queue.emptyQueue(roomid).then(function () {
      return done();
    });
  });

  it('get the users queue', function (done) {
    queue.getQueue(roomid).should.be.fulfilled.then(function (queue) {
      expect(queue).to.be.a('array');
    }).should.notify(done);
  });

  it('catch promised error when trying to remove song from empty queue', function (done) {
    queue.removeFirstSong('100', roomid).should.be.rejected.and.notify(done);
  });

  it('add 3 songs to the queue', function (done) {
    queue.addSong(song0, roomid).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      expect(updated[0].id).to.equal(song0.id);
      done();
    }).catch(done);
  });

  it('remove song from queue', function (done) {
    queue.addSong(song0, roomid).then(function () {
      return queue.removeFirstSong('100', roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      expect(updated).to.be.empty;
      done();
    }).catch(done);
  });
});

// handle users rooms

// handle upvote and downvote
describe('song rankings are stored', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // runs before all tests in this block
    queue.emptyQueue(roomid).then(function () {
      return queue.addSong(song0, roomid);
    }).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated.length, 3);
      done();
    }).catch(done);
  });

  it('record upvotes', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].upvotes, 1);
      assert.strictEqual(updated[2].downvotes, 0);
    }).then(function () {
      return done();
    }).catch(done);
  });
  it('record downvotes', function (done) {
    queue.downvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].downvotes, 1);
      assert.strictEqual(updated[2].upvotes, 0);
    }).then(function () {
      return done();
    }).catch(done);
  });
  it('track rankingChange after upvote and downvote', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].rankingChange, 1);
    }).then(function () {
      return queue.downvote(2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].rankingChange, 0);
      assert.strictEqual(updated[2].downvotes, 1);
      assert.strictEqual(updated[2].upvotes, 1);
    }).then(function () {
      return done();
    }).catch(done);
  });
});

describe('song rankings change order in queue', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid, queue: [] }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // runs before all tests in this block
    queue.emptyQueue(roomid).then(function () {
      return queue.addSong(song0, roomid);
    }).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated.length, 3);
      done();
    }).catch(done);
  });

  it('should move the last song to the second after 2 thumbs up', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.upvote(2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[1].id, song2.id);
      done();
    }).catch(done);
  });

  it('should move the second song to the third after 2 thumbs down', function (done) {
    queue.downvote(1, roomid).then(function () {
      return queue.downvote(1, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].id, song1.id);
      done();
    }).catch(done);
  });

  it('downvoting does not change playing song', function (done) {
    queue.downvote(0, roomid).then(function () {
      return queue.downvote(0, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[0].id, song0.id);
      done();
    }).catch(done);
  });

  it('upvoting second song doesn\'t preempt the playing song', function (done) {
    queue.upvote(1, roomid).then(function () {
      return queue.upvote(1, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[0].id, song0.id);
      done();
    }).catch(done);
  });
});
//# sourceMappingURL=data:application/json;base64,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QUFlO0FBQzVFLFVBQU0sTUFBTixDQUFhLENBQWIsRUFBZ0IsTUFBaEIsRUFDQyxJQURELENBQ007QUFBQSxhQUFNLE1BQU0sTUFBTixDQUFhLENBQWIsRUFBZ0IsTUFBaEIsQ0FBTjtBQUFBLEtBRE4sRUFFQyxJQUZELENBRU07QUFBQSxhQUFNLE1BQU0sUUFBTixDQUFlLE1BQWYsQ0FBTjtBQUFBLEtBRk4sRUFHQyxJQUhELENBR00sVUFBQyxPQUFELEVBQWE7QUFDakIsYUFBTyxXQUFQLENBQW1CLFFBQVEsQ0FBUixFQUFXLEVBQTlCLEVBQWtDLE1BQU0sRUFBeEM7QUFDQTtBQUNELEtBTkQsRUFPQyxLQVBELENBT08sSUFQUDtBQVFELEdBVEM7QUFlSCxDQTVFRCIsImZpbGUiOiJxdWV1ZS10ZXN0cy5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5jb25zdCBjaGFpQXNQcm9taXNlZCA9IHJlcXVpcmUoJ2NoYWktYXMtcHJvbWlzZWQnKTtcbmNvbnN0IGFzc2VydCA9IGNoYWkuYXNzZXJ0O1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuY29uc3Qgc2hvdWxkID0gY2hhaS5zaG91bGQoKTtcbmNvbnN0IGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xuY29uc3QgcXVldWUgPSByZXF1aXJlKCcuLi9zZXJ2ZXIvcm91dGVzL3F1ZXVlLmpzJyk7XG5jb25zdCBVc2VyID0gcmVxdWlyZSgnLi4vc2VydmVyL21vZGVscy9Vc2VyLmpzJyk7XG5cblxuY29uc3Qgc29uZzAgPSB7XG4gIGlkOiAnMTAwJyxcbiAgdGl0bGU6ICdubyBzbGVlcCB0aWxsIGJyb29rbHluJyxcbiAgZHVyYXRpb246ICc1MCcsXG4gIHN0cmVhbV91cmw6ICdzb3VuZGNsb3VkLzEwMScsXG4gIGFydHdvcmtfdXJsOiAnaHR0cDovL2JlYXN0aWUuY29tJyxcbn07XG5jb25zdCBzb25nMSA9IHtcbiAgaWQ6ICcxMDEnLFxuICB0aXRsZTogJ2xpa2UgYSBwcmF5ZXInLFxuICBkdXJhdGlvbjogJzcwJyxcbiAgc3RyZWFtX3VybDogJ3NvdW5kY2xvdWQvMTAyJyxcbiAgYXJ0d29ya191cmw6ICdtYWRvbm5hLmNvbScsXG59O1xuY29uc3Qgc29uZzIgPSB7XG4gIGlkOiAnMTAyJyxcbiAgdGl0bGU6ICdob3QgaW4gaGVycmUnLFxuICBkdXJhdGlvbjogJzMwJyxcbiAgc3RyZWFtX3VybDogJ3NvdW5kY2xvdWQvMTAzJyxcbiAgYXJ0d29ya191cmw6ICdodHRwOi8vaG90aW5oZXJyZS5jb20nLFxufTtcblxuZGVzY3JpYmUoJ2FkZCBhbmQgcmVtb3ZlIHNvbmdzIGZyb20gdGhlIHF1ZXVlJywgZnVuY3Rpb24oKSB7XG4gIGNvbnN0IHJvb21pZCA9ICcwMDAwMSc7XG5cbiAgYmVmb3JlKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICAvLyAgY3JlYXRlIGEgdXNlciB3aXRoIHRoZSByb29taWQ7XG4gICAgbmV3IFVzZXIoe3VzZXJuYW1lOid0ZXN0cXVldWV1c2VyJywgcGFzc3dvcmQ6J3B3Jywgcm9vbWlkOiByb29taWR9KVxuICAgIC5zYXZlKChlcnIsIHN1Y2Nlc3MpID0+IGRvbmUoZXJyKSk7XG4gIH0pO1xuXG4gIGFmdGVyKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBVc2VyLnJlbW92ZSh7IHJvb21pZDogcm9vbWlkIH0pLnRoZW4oKCkgPT4gZG9uZSgpKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaChmdW5jdGlvbihkb25lKSB7XG4gICAgLy8gRW1wdHkgdGhlIHF1ZXVlXG4gICAgcXVldWUuZW1wdHlRdWV1ZShyb29taWQpLnRoZW4oKCkgPT4gZG9uZSgpKTtcbiAgfSk7XG5cblxuXG5cbiAgaXQoJ2dldCB0aGUgdXNlcnMgcXVldWUnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUuZ2V0UXVldWUocm9vbWlkKS5zaG91bGQuYmUuZnVsZmlsbGVkLnRoZW4oZnVuY3Rpb24ocXVldWUpIHtcbiAgICAgIGV4cGVjdChxdWV1ZSkudG8uYmUuYSgnYXJyYXknKTtcbiAgICB9KS5zaG91bGQubm90aWZ5KGRvbmUpO1xuICB9KTtcblxuICBpdCgnY2F0Y2ggcHJvbWlzZWQgZXJyb3Igd2hlbiB0cnlpbmcgdG8gcmVtb3ZlIHNvbmcgZnJvbSBlbXB0eSBxdWV1ZScsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS5yZW1vdmVGaXJzdFNvbmcoJzEwMCcsIHJvb21pZCkuc2hvdWxkLmJlLnJlamVjdGVkLmFuZC5ub3RpZnkoZG9uZSk7XG4gIH0pO1xuXG4gIGl0KCdhZGQgMyBzb25ncyB0byB0aGUgcXVldWUnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUuYWRkU29uZyhzb25nMCwgcm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzEsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuYWRkU29uZyhzb25nMiwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKGZ1bmN0aW9uKHVwZGF0ZWQpIHtcbiAgICAgIGV4cGVjdCh1cGRhdGVkWzBdLmlkKS50by5lcXVhbChzb25nMC5pZCk7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuXG4gIGl0KCdyZW1vdmUgc29uZyBmcm9tIHF1ZXVlJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLmFkZFNvbmcoc29uZzAsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5yZW1vdmVGaXJzdFNvbmcoJzEwMCcsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgZXhwZWN0KHVwZGF0ZWQpLnRvLmJlLmVtcHR5O1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxufSk7XG5cbi8vIGhhbmRsZSB1c2VycyByb29tc1xuXG5cblxuXG5cblxuXG5cbi8vIGhhbmRsZSB1cHZvdGUgYW5kIGRvd252b3RlXG5kZXNjcmliZSgnc29uZyByYW5raW5ncyBhcmUgc3RvcmVkJywgZnVuY3Rpb24oKSB7XG4gIGNvbnN0IHJvb21pZCA9ICcwMDAwMSc7XG5cbiAgYmVmb3JlKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICAvLyAgY3JlYXRlIGEgdXNlciB3aXRoIHRoZSByb29taWQ7XG4gICAgbmV3IFVzZXIoe3VzZXJuYW1lOid0ZXN0cXVldWV1c2VyJywgcGFzc3dvcmQ6J3B3Jywgcm9vbWlkOiByb29taWR9KVxuICAgIC5zYXZlKChlcnIsIHN1Y2Nlc3MpID0+IGRvbmUoZXJyKSk7XG4gIH0pO1xuXG4gIGFmdGVyKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBVc2VyLnJlbW92ZSh7IHJvb21pZDogcm9vbWlkIH0pLnRoZW4oKCkgPT4gZG9uZSgpKTtcbiAgfSk7XG5cblxuXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oZG9uZSkge1xuICAgIC8vIHJ1bnMgYmVmb3JlIGFsbCB0ZXN0cyBpbiB0aGlzIGJsb2NrXG4gICAgcXVldWUuZW1wdHlRdWV1ZShyb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuYWRkU29uZyhzb25nMCwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5hZGRTb25nKHNvbmcxLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzIsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWQubGVuZ3RoLCAzKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cbiAgaXQoJ3JlY29yZCB1cHZvdGVzJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLnVwdm90ZSgyLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0udXB2b3RlcywgMSk7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5kb3dudm90ZXMsIDApO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4gZG9uZSgpKVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG4gIGl0KCdyZWNvcmQgZG93bnZvdGVzJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLmRvd252b3RlKDIsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5kb3dudm90ZXMsIDEpO1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0udXB2b3RlcywgMCk7XG4gICAgfSlcbiAgICAudGhlbigoKSA9PiBkb25lKCkpXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcbiAgaXQoJ3RyYWNrIHJhbmtpbmdDaGFuZ2UgYWZ0ZXIgdXB2b3RlIGFuZCBkb3dudm90ZScsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS51cHZvdGUoMiwgcm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzJdLnJhbmtpbmdDaGFuZ2UsIDEpO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZG93bnZvdGUoMiwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5yYW5raW5nQ2hhbmdlLCAwKTtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzJdLmRvd252b3RlcywgMSk7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS51cHZvdGVzLCAxKTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IGRvbmUoKSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuXG59KTtcblxuZGVzY3JpYmUoJ3NvbmcgcmFua2luZ3MgY2hhbmdlIG9yZGVyIGluIHF1ZXVlJywgZnVuY3Rpb24oKSB7XG4gIGNvbnN0IHJvb21pZCA9ICcwMDAwMSc7XG5cbiAgYmVmb3JlKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICAvLyAgY3JlYXRlIGEgdXNlciB3aXRoIHRoZSByb29taWQ7XG4gICAgbmV3IFVzZXIoe3VzZXJuYW1lOid0ZXN0cXVldWV1c2VyJywgcGFzc3dvcmQ6J3B3Jywgcm9vbWlkOiByb29taWQsIHF1ZXVlOiBbXX0pXG4gICAgLnNhdmUoKGVyciwgc3VjY2VzcykgPT4gZG9uZShlcnIpKTtcbiAgfSk7XG5cbiAgYWZ0ZXIoZnVuY3Rpb24oZG9uZSkge1xuICAgIFVzZXIucmVtb3ZlKHsgcm9vbWlkOiByb29taWQgfSkudGhlbigoKSA9PiBkb25lKCkpO1xuICB9KTtcblxuXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oZG9uZSkge1xuICAgIC8vIHJ1bnMgYmVmb3JlIGFsbCB0ZXN0cyBpbiB0aGlzIGJsb2NrXG4gICAgcXVldWUuZW1wdHlRdWV1ZShyb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuYWRkU29uZyhzb25nMCwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5hZGRTb25nKHNvbmcxLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzIsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWQubGVuZ3RoLCAzKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBtb3ZlIHRoZSBsYXN0IHNvbmcgdG8gdGhlIHNlY29uZCBhZnRlciAyIHRodW1icyB1cCcsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS51cHZvdGUoMiwgcm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLnVwdm90ZSgyLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzFdLmlkLCBzb25nMi5pZCk7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbW92ZSB0aGUgc2Vjb25kIHNvbmcgdG8gdGhlIHRoaXJkIGFmdGVyIDIgdGh1bWJzIGRvd24nLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUuZG93bnZvdGUoMSwgcm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmRvd252b3RlKDEsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0uaWQsIHNvbmcxLmlkKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cbiAgaXQoJ2Rvd252b3RpbmcgZG9lcyBub3QgY2hhbmdlIHBsYXlpbmcgc29uZycsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS5kb3dudm90ZSgwLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZG93bnZvdGUoMCwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFswXS5pZCwgc29uZzAuaWQpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxuICAgIGl0KCd1cHZvdGluZyBzZWNvbmQgc29uZyBkb2VzblxcJ3QgcHJlZW1wdCB0aGUgcGxheWluZyBzb25nJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLnVwdm90ZSgxLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUudXB2b3RlKDEsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMF0uaWQsIHNvbmcwLmlkKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cblxuXG5cblxufSk7XG5cbiJdfQ==