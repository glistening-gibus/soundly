'use strict';

var chai = require('chai');
var chaiAsPromised = require('chai-as-promised');
var assert = chai.assert;
chai.use(chaiAsPromised);
var should = chai.should();
var expect = chai.expect;
var queue = require('../server/routes/queue.js');
var User = require('../server/models/User.js');

var song0 = {
  id: '100',
  title: 'no sleep till brooklyn',
  duration: '50',
  stream_url: 'soundcloud/101',
  artwork_url: 'http://beastie.com'
};
var song1 = {
  id: '101',
  title: 'like a prayer',
  duration: '70',
  stream_url: 'soundcloud/102',
  artwork_url: 'madonna.com'
};
var song2 = {
  id: '102',
  title: 'hot in herre',
  duration: '30',
  stream_url: 'soundcloud/103',
  artwork_url: 'http://hotinherre.com'
};

describe('add and remove songs from the queue', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // Empty the queue
    queue.emptyQueue(roomid).then(function () {
      return done();
    });
  });

  it('get the users queue', function (done) {
    queue.getQueue(roomid).should.be.fulfilled.then(function (queue) {
      expect(queue).to.be.a('array');
    }).should.notify(done);
  });

  it('catch promised error when trying to remove song from empty queue', function (done) {
    queue.removeFirstSong('100', roomid).should.be.rejected.and.notify(done);
  });

  it('add 3 songs to the queue', function (done) {
    queue.addSong(song0, roomid).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      expect(updated[0].id).to.equal(song0.id);
      done();
    }).catch(done);
  });

  it('remove song from queue', function (done) {
    queue.addSong(song0, roomid).then(function () {
      return queue.removeFirstSong('100', roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      expect(updated).to.be.empty;
      done();
    }).catch(done);
  });
});

// handle users rooms

// handle upvote and downvote
describe('song rankings are stored', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // runs before all tests in this block
    queue.emptyQueue(roomid).then(function () {
      return queue.addSong(song0, roomid);
    }).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated.length, 3);
      done();
    }).catch(done);
  });

  it('record upvotes', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].upvotes, 1);
      assert.strictEqual(updated[2].downvotes, 0);
    }).then(function () {
      return done();
    }).catch(done);
  });
  it('record downvotes', function (done) {
    queue.downvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].downvotes, 1);
      assert.strictEqual(updated[2].upvotes, 0);
    }).then(function () {
      return done();
    }).catch(done);
  });
  it('track rankingChange after upvote and downvote', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].rankingChange, 1);
    }).then(function () {
      return queue.downvote(2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].rankingChange, 0);
      assert.strictEqual(updated[2].downvotes, 1);
      assert.strictEqual(updated[2].upvotes, 1);
    }).then(function () {
      return done();
    }).catch(done);
  });
});

describe('song rankings change order in queue', function () {
  var roomid = '00001';

  before(function (done) {
    //  create a user with the roomid;
    new User({ username: 'testqueueuser', password: 'pw', roomid: roomid }).save(function (err, success) {
      return done(err);
    });
  });

  after(function (done) {
    User.remove({ roomid: roomid }).then(function () {
      return done();
    });
  });

  beforeEach(function (done) {
    // runs before all tests in this block
    queue.emptyQueue(roomid).then(function () {
      return queue.addSong(song0, roomid);
    }).then(function () {
      return queue.addSong(song1, roomid);
    }).then(function () {
      return queue.addSong(song2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated.length, 3);
      done();
    }).catch(done);
  });

  it('should move the last song to the second after 2 thumbs up', function (done) {
    queue.upvote(2, roomid).then(function () {
      return queue.upvote(2, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[1].id, song2.id);
      done();
    }).catch(done);
  });

  it('should move the second song to the third after 2 thumbs down', function (done) {
    queue.downvote(1, roomid).then(function () {
      return queue.downvote(1, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[2].id, song1.id);
      done();
    }).catch(done);
  });

  it('downvoting does not change playing song', function (done) {
    queue.downvote(0, roomid).then(function () {
      return queue.downvote(0, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[0].id, song0.id);
      done();
    }).catch(done);
  });

  it('upvoting second song doesn\'t preempt the playing song', function (done) {
    queue.upvote(1, roomid).then(function () {
      return queue.upvote(1, roomid);
    }).then(function () {
      return queue.getQueue(roomid);
    }).then(function (updated) {
      assert.strictEqual(updated[0].id, song0.id);
      done();
    }).catch(done);
  });
});
//# sourceMappingURL=data:application/json;base64,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QU4sQ0FBYSxDQUFiLEVBQWdCLE1BQWhCLEVBQ0MsSUFERCxDQUNNO0FBQUEsYUFBTSxNQUFNLE1BQU4sQ0FBYSxDQUFiLEVBQWdCLE1BQWhCLENBQU47QUFBQSxLQUROLEVBRUMsSUFGRCxDQUVNO0FBQUEsYUFBTSxNQUFNLFFBQU4sQ0FBZSxNQUFmLENBQU47QUFBQSxLQUZOLEVBR0MsSUFIRCxDQUdNLFVBQUMsT0FBRCxFQUFhO0FBQ2pCLGFBQU8sV0FBUCxDQUFtQixRQUFRLENBQVIsRUFBVyxFQUE5QixFQUFrQyxNQUFNLEVBQXhDO0FBQ0E7QUFDRCxLQU5ELEVBT0MsS0FQRCxDQU9PLElBUFA7QUFRRCxHQVRDO0FBZUgsQ0E1RUQiLCJmaWxlIjoicXVldWUtdGVzdHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjaGFpID0gcmVxdWlyZSgnY2hhaScpO1xuY29uc3QgY2hhaUFzUHJvbWlzZWQgPSByZXF1aXJlKCdjaGFpLWFzLXByb21pc2VkJyk7XG5jb25zdCBhc3NlcnQgPSBjaGFpLmFzc2VydDtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmNvbnN0IHNob3VsZCA9IGNoYWkuc2hvdWxkKCk7XG5jb25zdCBleHBlY3QgPSBjaGFpLmV4cGVjdDtcbmNvbnN0IHF1ZXVlID0gcmVxdWlyZSgnLi4vc2VydmVyL3JvdXRlcy9xdWV1ZS5qcycpO1xuY29uc3QgVXNlciA9IHJlcXVpcmUoJy4uL3NlcnZlci9tb2RlbHMvVXNlci5qcycpO1xuXG5cbmNvbnN0IHNvbmcwID0ge1xuICBpZDogJzEwMCcsXG4gIHRpdGxlOiAnbm8gc2xlZXAgdGlsbCBicm9va2x5bicsXG4gIGR1cmF0aW9uOiAnNTAnLFxuICBzdHJlYW1fdXJsOiAnc291bmRjbG91ZC8xMDEnLFxuICBhcnR3b3JrX3VybDogJ2h0dHA6Ly9iZWFzdGllLmNvbScsXG59O1xuY29uc3Qgc29uZzEgPSB7XG4gIGlkOiAnMTAxJyxcbiAgdGl0bGU6ICdsaWtlIGEgcHJheWVyJyxcbiAgZHVyYXRpb246ICc3MCcsXG4gIHN0cmVhbV91cmw6ICdzb3VuZGNsb3VkLzEwMicsXG4gIGFydHdvcmtfdXJsOiAnbWFkb25uYS5jb20nLFxufTtcbmNvbnN0IHNvbmcyID0ge1xuICBpZDogJzEwMicsXG4gIHRpdGxlOiAnaG90IGluIGhlcnJlJyxcbiAgZHVyYXRpb246ICczMCcsXG4gIHN0cmVhbV91cmw6ICdzb3VuZGNsb3VkLzEwMycsXG4gIGFydHdvcmtfdXJsOiAnaHR0cDovL2hvdGluaGVycmUuY29tJyxcbn07XG5cbmRlc2NyaWJlKCdhZGQgYW5kIHJlbW92ZSBzb25ncyBmcm9tIHRoZSBxdWV1ZScsIGZ1bmN0aW9uKCkge1xuICBjb25zdCByb29taWQgPSAnMDAwMDEnO1xuXG4gIGJlZm9yZShmdW5jdGlvbihkb25lKSB7XG4gICAgLy8gIGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgcm9vbWlkO1xuICAgIG5ldyBVc2VyKHt1c2VybmFtZTondGVzdHF1ZXVldXNlcicsIHBhc3N3b3JkOidwdycsIHJvb21pZDogcm9vbWlkfSlcbiAgICAuc2F2ZSgoZXJyLCBzdWNjZXNzKSA9PiBkb25lKGVycikpO1xuICB9KTtcblxuICBhZnRlcihmdW5jdGlvbihkb25lKSB7XG4gICAgVXNlci5yZW1vdmUoeyByb29taWQ6IHJvb21pZCB9KS50aGVuKCgpID0+IGRvbmUoKSk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oZG9uZSkge1xuICAgIC8vIEVtcHR5IHRoZSBxdWV1ZVxuICAgIHF1ZXVlLmVtcHR5UXVldWUocm9vbWlkKS50aGVuKCgpID0+IGRvbmUoKSk7XG4gIH0pO1xuXG5cblxuXG4gIGl0KCdnZXQgdGhlIHVzZXJzIHF1ZXVlJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkuc2hvdWxkLmJlLmZ1bGZpbGxlZC50aGVuKGZ1bmN0aW9uKHF1ZXVlKSB7XG4gICAgICBleHBlY3QocXVldWUpLnRvLmJlLmEoJ2FycmF5Jyk7XG4gICAgfSkuc2hvdWxkLm5vdGlmeShkb25lKTtcbiAgfSk7XG5cbiAgaXQoJ2NhdGNoIHByb21pc2VkIGVycm9yIHdoZW4gdHJ5aW5nIHRvIHJlbW92ZSBzb25nIGZyb20gZW1wdHkgcXVldWUnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUucmVtb3ZlRmlyc3RTb25nKCcxMDAnLCByb29taWQpLnNob3VsZC5iZS5yZWplY3RlZC5hbmQubm90aWZ5KGRvbmUpO1xuICB9KTtcblxuICBpdCgnYWRkIDMgc29uZ3MgdG8gdGhlIHF1ZXVlJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLmFkZFNvbmcoc29uZzAsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5hZGRTb25nKHNvbmcxLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzIsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbihmdW5jdGlvbih1cGRhdGVkKSB7XG4gICAgICBleHBlY3QodXBkYXRlZFswXS5pZCkudG8uZXF1YWwoc29uZzAuaWQpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxuICBpdCgncmVtb3ZlIHNvbmcgZnJvbSBxdWV1ZScsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS5hZGRTb25nKHNvbmcwLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUucmVtb3ZlRmlyc3RTb25nKCcxMDAnLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGV4cGVjdCh1cGRhdGVkKS50by5iZS5lbXB0eTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cbn0pO1xuXG4vLyBoYW5kbGUgdXNlcnMgcm9vbXNcblxuXG5cblxuXG5cblxuXG4vLyBoYW5kbGUgdXB2b3RlIGFuZCBkb3dudm90ZVxuZGVzY3JpYmUoJ3NvbmcgcmFua2luZ3MgYXJlIHN0b3JlZCcsIGZ1bmN0aW9uKCkge1xuICBjb25zdCByb29taWQgPSAnMDAwMDEnO1xuXG4gIGJlZm9yZShmdW5jdGlvbihkb25lKSB7XG4gICAgLy8gIGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgcm9vbWlkO1xuICAgIG5ldyBVc2VyKHt1c2VybmFtZTondGVzdHF1ZXVldXNlcicsIHBhc3N3b3JkOidwdycsIHJvb21pZDogcm9vbWlkfSlcbiAgICAuc2F2ZSgoZXJyLCBzdWNjZXNzKSA9PiBkb25lKGVycikpO1xuICB9KTtcblxuICBhZnRlcihmdW5jdGlvbihkb25lKSB7XG4gICAgVXNlci5yZW1vdmUoeyByb29taWQ6IHJvb21pZCB9KS50aGVuKCgpID0+IGRvbmUoKSk7XG4gIH0pO1xuXG5cblxuICBiZWZvcmVFYWNoKGZ1bmN0aW9uKGRvbmUpIHtcbiAgICAvLyBydW5zIGJlZm9yZSBhbGwgdGVzdHMgaW4gdGhpcyBibG9ja1xuICAgIHF1ZXVlLmVtcHR5UXVldWUocm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzAsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuYWRkU29uZyhzb25nMSwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5hZGRTb25nKHNvbmcyLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkLmxlbmd0aCwgMyk7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuXG4gIGl0KCdyZWNvcmQgdXB2b3RlcycsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS51cHZvdGUoMiwgcm9vbWlkKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzJdLnVwdm90ZXMsIDEpO1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0uZG93bnZvdGVzLCAwKTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IGRvbmUoKSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuICBpdCgncmVjb3JkIGRvd252b3RlcycsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS5kb3dudm90ZSgyLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0uZG93bnZvdGVzLCAxKTtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzJdLnVwdm90ZXMsIDApO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4gZG9uZSgpKVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG4gIGl0KCd0cmFjayByYW5raW5nQ2hhbmdlIGFmdGVyIHVwdm90ZSBhbmQgZG93bnZvdGUnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUudXB2b3RlKDIsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5yYW5raW5nQ2hhbmdlLCAxKTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmRvd252b3RlKDIsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0ucmFua2luZ0NoYW5nZSwgMCk7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5kb3dudm90ZXMsIDEpO1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMl0udXB2b3RlcywgMSk7XG4gICAgfSlcbiAgICAudGhlbigoKSA9PiBkb25lKCkpXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxufSk7XG5cbmRlc2NyaWJlKCdzb25nIHJhbmtpbmdzIGNoYW5nZSBvcmRlciBpbiBxdWV1ZScsIGZ1bmN0aW9uKCkge1xuICBjb25zdCByb29taWQgPSAnMDAwMDEnO1xuXG4gIGJlZm9yZShmdW5jdGlvbihkb25lKSB7XG4gICAgLy8gIGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgcm9vbWlkO1xuICAgIG5ldyBVc2VyKHt1c2VybmFtZTondGVzdHF1ZXVldXNlcicsIHBhc3N3b3JkOidwdycsIHJvb21pZDogcm9vbWlkfSlcbiAgICAuc2F2ZSgoZXJyLCBzdWNjZXNzKSA9PiBkb25lKGVycikpO1xuICB9KTtcblxuICBhZnRlcihmdW5jdGlvbihkb25lKSB7XG4gICAgVXNlci5yZW1vdmUoeyByb29taWQ6IHJvb21pZCB9KS50aGVuKCgpID0+IGRvbmUoKSk7XG4gIH0pO1xuXG5cbiAgYmVmb3JlRWFjaChmdW5jdGlvbihkb25lKSB7XG4gICAgLy8gcnVucyBiZWZvcmUgYWxsIHRlc3RzIGluIHRoaXMgYmxvY2tcbiAgICBxdWV1ZS5lbXB0eVF1ZXVlKHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5hZGRTb25nKHNvbmcwLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmFkZFNvbmcoc29uZzEsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuYWRkU29uZyhzb25nMiwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZC5sZW5ndGgsIDMpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIG1vdmUgdGhlIGxhc3Qgc29uZyB0byB0aGUgc2Vjb25kIGFmdGVyIDIgdGh1bWJzIHVwJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLnVwdm90ZSgyLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUudXB2b3RlKDIsIHJvb21pZCkpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZ2V0UXVldWUocm9vbWlkKSlcbiAgICAudGhlbigodXBkYXRlZCkgPT4ge1xuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHVwZGF0ZWRbMV0uaWQsIHNvbmcyLmlkKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaChkb25lKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBtb3ZlIHRoZSBzZWNvbmQgc29uZyB0byB0aGUgdGhpcmQgYWZ0ZXIgMiB0aHVtYnMgZG93bicsIGZ1bmN0aW9uKGRvbmUpIHtcbiAgICBxdWV1ZS5kb3dudm90ZSgxLCByb29taWQpXG4gICAgLnRoZW4oKCkgPT4gcXVldWUuZG93bnZvdGUoMSwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFsyXS5pZCwgc29uZzEuaWQpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxuICBpdCgnZG93bnZvdGluZyBkb2VzIG5vdCBjaGFuZ2UgcGxheWluZyBzb25nJywgZnVuY3Rpb24oZG9uZSkge1xuICAgIHF1ZXVlLmRvd252b3RlKDAsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5kb3dudm90ZSgwLCByb29taWQpKVxuICAgIC50aGVuKCgpID0+IHF1ZXVlLmdldFF1ZXVlKHJvb21pZCkpXG4gICAgLnRoZW4oKHVwZGF0ZWQpID0+IHtcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh1cGRhdGVkWzBdLmlkLCBzb25nMC5pZCk7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZG9uZSk7XG4gIH0pO1xuXG4gICAgaXQoJ3Vwdm90aW5nIHNlY29uZCBzb25nIGRvZXNuXFwndCBwcmVlbXB0IHRoZSBwbGF5aW5nIHNvbmcnLCBmdW5jdGlvbihkb25lKSB7XG4gICAgcXVldWUudXB2b3RlKDEsIHJvb21pZClcbiAgICAudGhlbigoKSA9PiBxdWV1ZS51cHZvdGUoMSwgcm9vbWlkKSlcbiAgICAudGhlbigoKSA9PiBxdWV1ZS5nZXRRdWV1ZShyb29taWQpKVxuICAgIC50aGVuKCh1cGRhdGVkKSA9PiB7XG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodXBkYXRlZFswXS5pZCwgc29uZzAuaWQpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGRvbmUpO1xuICB9KTtcblxuXG5cblxuXG59KTtcblxuIl19